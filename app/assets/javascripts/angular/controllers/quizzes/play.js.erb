app.controller('QuizzesPlayCtrl', ['$scope', '$http', '$location', '$auth', '$routeParams', '$interval',  function($scope, $http, $location, $auth, $routeParams, $interval){

  var choices = [[0,1,2],[0,2,1],[1,0,2],[1,2,0],[2,1,0],[2,0,1]];

  $auth.validateUser().then(function (resp) {
    console.log(resp);
    $scope.user = resp;
  }).catch(function (resp) {
    console.log(resp);
  });

  $http.get('/quizzes/' + $routeParams.id).success(function(response){
    console.log(response);
    $scope.quiz = response;
    $scope.startMode = true;
    $scope.playMode = false;
    $scope.gameOver = false;
    $scope.numQuestions = $scope.quiz.questions.length;
    $scope.timer = $scope.numQuestions * 5;
  });

  var timerId;
  var countDownOneSecond =  function () {
    $scope.timer--;
    if ($scope.timer == 0)
      gameOver();
  };

  $scope.startCount = function () {
    timerId = $interval(countDownOneSecond, 1000);
  };

  var randomizeAnswers = function() {
    var seq = choices[Math.floor(Math.random()*6)];
    $scope.choices[seq[0]] = $scope.currentQ.answer;
    $scope.choices[seq[1]] = $scope.currentQ.dummy1;
    $scope.choices[seq[2]] = $scope.currentQ.dummy2;
  }

  $scope.startQuiz = function() {
    $scope.startMode = false;
    $scope.playMode = true;
    $scope.gameOver = false;
    $scope.currentQId = 0;
    $scope.score = 0;
    $scope.tried = 0;
    $scope.currentQ = $scope.quiz.questions[$scope.currentQId];
    $scope.choices = [];
    randomizeAnswers();
    $scope.startCount();

  };

  $scope.chkAnswer = function(choice) {
    var answer = $scope.currentQ.answer;
    $scope.tried ++;
    if (choice == answer) {
      $scope.score ++;
    }
    $scope.currentQId ++;
    if ($scope.currentQId < $scope.numQuestions) {
      newQuestion ();
    } else {
      gameOver();
    }
  };

  function newQuestion () {
    $scope.currentQ =
      $scope.quiz.questions[$scope.currentQId];
    randomizeAnswers();
  }

  $scope.skipQuestion = function (choice) {
    $scope.currentQId ++;
    if ($scope.currentQId < $scope.numQuestions) {
      newQuestion ();
    } else {
      gameOver();
    }
  };

  function gameOver () {
    $interval.cancel(timerId);

    var url = '/quizzes/' + $routeParams.id +'/results';
    $http.post(url, { user_id: $scope.user.id, score: $scope.score })
    .success(function(response){
      console.log(response);
      $scope.playMode = false;
      $scope.gameOver = true;
    });
  }

  $scope.gameReset = function () {
    $scope.startMode = true;
    $scope.playMode = false;
    $scope.gameOver = false;
  };


}]);